{% extends 'web/index.html' %}

{% load i18n %}

{% block content %}

<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">{{ project.name }}</h1>
                    <h5 class="font-italic">{{ project.get_type_display }}</h5>
                </div><!-- /.col -->
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'index' %}">Projects</a></li>
                        <li class="breadcrumb-item active">{{ project.name }}</li>
                    </ol>
                </div><!-- /.col -->
            </div><!-- /.row -->
        </div><!-- /.container-fluid -->
        {% if messages %}
        <div class="modal fade" id="messageModal" tabindex="-1" role="dialog" aria-labelledby="messageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title" id="MessageTitle">Success</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                    </div>
                    <div class="modal-body">
                         <ul class="messages">
                            {% for message in messages %}
                              {{ message }}
                            {% endfor %}
                         </ul>
                    </div>
                    <div class="modal-footer">
                        <a type="button" class="btn btn-primary" data-dismiss="modal">Close</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <!-- /.content-header -->
    <!-- Main content -->
    <div class="content">
        <div class="container-flex bg-white rounded" style="text-align: left;min-height: 40rem;margin: 30px; padding:10px; margin-left: 0px;">

                <ul class="nav nav-tabs" id="projectTab">
                    <li class="nav-item active">
                        <a class="nav-link active text-secondary" data-toggle="tab" href="#data">{% translate "Data" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-secondary" data-toggle="tab" href="#Features">{% translate "Features" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-secondary" data-toggle="tab" href="#labels">{% translate "Labels" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-secondary" data-toggle="tab" href="#models">{% translate "Models" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-secondary" data-toggle="tab" href="#metadata">{% translate "Metadata" %}</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="data">
                        <div style="margin: 10px; margin-left: 0px;" id="data-table"></div>
                        <!-- <div class="pagination-table" style="margin: 10px; margin-left: 0px;" id="pagination">
                            {% for p in n_pages %}
                                <a href="#{{ p }}">{{ p }}</a>
                            {% endfor %}
                        </div> -->
                    </div>
                    <div class="tab-pane fade" id="labels">
                        <a class="btn btn-outline-primary" href="{{ project.id }}/create_label/"
                           style="margin: 10px; margin-left: 0px;">
                            <i class="fas fa-fw fa-plus"></i>
                            <span>{% translate "NewLabel" %}</span>
                        </a>

                        <!-- Table -->
                        <table class="table table-hover">
                            {% for label in labels %}
                            <tr>
                                <td>{{ label.name }}</td>
                                <td>{{ label.description }}</td>
                                <td style="text-align: center;">
                                    <div class="rounded-circle" style="width: 2rem; height: 2rem; background-color:{{ label.color }};"></div>
                                </td>
                                <td>
                                        <a href="{{ project.id }}/clone/{{label.id}}" id='{{label.id}}'>
                                        <span class="far fa-clone"></span>
                                    </a>
                                </td>
                                <td>
                                        <a href="{{ project.id }}/update/{{label.id}}" id='{{label.id}}'>
                                        <span class="fas fa-pencil-alt"></span>
                                    </a>
                                </td>
                                <td>
                                    <a href="{{ project.id }}/delete/{{label.id}}" class="delete"
                                       data-confirm="Do you really want to delete these label? This process cannot be undone.">
                                        <span style="color: red;" class="fas fa-trash-alt"></span>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                    <div class="tab-pane fade" id="models">
                        <div style="margin: 10px; margin-left: 0px;">
                            <a type="button" class="btn btn-lg btn-success" href="{{ project.id }}/train/">Train Model</a>
                            <div style="margin: 10px; margin-left: 0px;">
                                <!-- Table -->
                                <table class="table table-hover" id="model-table">
                                    <thead>
                                        <tr>
                                            <th scope="col"></th>
                                            <th scope="col">Start</th>
                                            <th scope="col">Finish</th>
                                            <th scope="col">Accuracy</th>
                                            <th scope="col">Precision</th>
                                            <th scope="col">Recall</th>
                                            <th scope="col">F1 Score</th>
                                            <th scope="col">Confusion Matrix</th>
                                            <th scope="col"></th>
                                            <th scope="col"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for pred in predictions %}
                                        <!--<tr style="background-color:{% if pred.status == True %}#b1cbd8{% else %}#FFFFB2{% endif %};">-->
                                        <tr>
                                            {% if pred.status == 1 %}
                                                <td><span class="badge badge-success">Success</span></td>
                                                <td>{{ pred.created_at }}</td>
                                                <td>{{ pred.updated_at }}</td>
                                                <td>{{ pred.accuracy }}</td>
                                                <td>{{ pred.precision }}</td>
                                                <td>{{ pred.recall }}</td>
                                                <td>{{ pred.f1_score }}</td>
                                                <td>{{ pred.confusion_matrix|linebreaksbr }}</td>
                                                <td><a href="{{ project.id }}/download/{{ pred.id }}" download><span class="fas fa-download"></span></a></td>
                                                <td>
                                                    <a href="{{ project.id }}/deletepred/{{ pred.id }}" class="delete"
                                                       data-confirm="Do you really want to delete these prediction? This process cannot be undone.">
                                                        <span style="color: red;" class="fas fa-trash-alt"></span>
                                                    </a>
                                                </td>

                                            {% else %}
                                                {% if pred.status == 2%}
                                                  <td><span class="badge badge-warning">Trainning</span></td>
                                                {% elif pred.status == 3%}
                                                    <td><span class="badge badge-danger">Error</span></td>
                                                {% endif %}
                                                <td>{{ pred.created_at }}</td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td>
                                                    <a href="{{ project.id }}/deletepred/{{ pred.id }}" class="delete"
                                                       data-confirm="Do you really want to delete these prediction? This process cannot be undone.">
                                                        <span style="color: red;" class="fas fa-trash-alt"></span>
                                                    </a>
                                                </td>
                                            {% endif %}
                                      </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade   " id="Features">
                        <div style="margin: 10px; margin-left: 0px;">

                            <!-- <table class="table table-hover">
                                {% for columnstest in columnscsv %}
                                <tr>
                                    <td>{{columnstest}}</td>
                                </tr>
                                {% endfor %} -->

                            <table class="table table-hover">
                                <thead>
                                  <tr>
                                    <th scope="col">COLUMN</th>
                                    <th scope="col">FEATURES</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <form method="post">
                                     {{ formset.management_form }}
                                     <b><font st color=red> {{ formset.non_form_errors }}</font></b>
                                     {% csrf_token %}
                                     {% for form in formset %}
                                     {{ form.id }}
                                     {{ form.column.as_hidden }}
                                     <tr>
                                       <td>{{ form.column.value }}</td>
                                       <td>{{form.type}}</td>
                                       <td></td>
                                     </tr>
                                     {% endfor %}
                                     <tr>
                                       <td></td>
                                       <td>
                                           <button class="btn btn-lg btn-success" type="submit">{% translate " Save" %}</button>
                                       </td>
                                     </tr>
                                 </form>
                               </tbody>
                             </table>

                       </div>
                    </div>

                   <div class="tab-pane fade   " id="metadata">
                       <div style="margin: 10px; margin-left: 0px;">
                           <p>Metadata</p>
                       </div>
                   </div>
               </div>

        </div> <!-- /.container-fluid -->
   </div>
    <!-- /.content -->
  </div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">

  $('#projectTab a').click(function(e) {
      e.preventDefault();
      $(this).tab('show');
    });

    // store the currently selected tab in the hash value
    $("ul.nav-tabs > li > a").on("shown.bs.tab", function(e) {
      var id = $(e.target).attr("href").substr(1);
      window.location.hash = id;
    });

    // on load of the page: switch to the currently selected tab
    var hash = window.location.hash;
    $('#projectTab a[href="' + hash + '"]').tab('show');


    var deleteLinks = document.querySelectorAll('.delete');

    for (var i = 0; i < deleteLinks.length; i++) {
      deleteLinks[i].addEventListener('click', function(event) {
          event.preventDefault();

          var choice = confirm(this.getAttribute('data-confirm'));

          if (choice) {
            window.location.href = this.getAttribute('href');
          }
      });
    }

     $(document).ready(function(){
        $('#messageModal').modal({show:true});
    });

     $(document).ready( function () {
        $('#model-table').DataTable({
             searching: false,
             paging: false,
             "lengthChange": false,
             columns: [
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                { orderable: false },
              ]
        });
     } );

    var data = JSON.parse("{{loaded_data|escapejs}}");

    var container = document.getElementById('data-table');
    var hot = new Handsontable(container, {
        //data: getData(),
        data: data,
        colHeaders: JSON.parse("{{columns|escapejs}}"),
        rowHeaders: true,
        filters: true,
        dropdownMenu: true,
        licenseKey: 'non-commercial-and-evaluation',
    });
    Handsontable.dom.addEvent(window, 'hashchange', function (event) {
        hot.loadData(getData());
    });

</script>
{% endblock javascript %}
